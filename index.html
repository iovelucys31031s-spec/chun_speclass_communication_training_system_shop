<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘æ˜¯è³¼ç‰©å°é”äºº</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <style>
        :root {
            /* SEVENTEEN æ‡‰æ´è‰² */
            --rose-quartz: #F7CAC9;
            --serenity: #92A8D1;
            --rose-dark: #d68c8b;
            --serenity-dark: #6e86b3;
            --gradient-bar: linear-gradient(90deg, #92A8D1 0%, #F7CAC9 100%);
            
            --text-boss: #FFFFFF;
            --text-cust: #444444;
            --bg-boss-btn: #5b7bb2;
            --bg-cust-btn: #e07b7b;
        }

        * { box-sizing: border-box; }

        html, body { height: 100%; width: 100%; overflow: hidden; }

        body {
            font-family: "Microsoft JhengHei", "Heiti TC", sans-serif;
            margin: 0; padding: 0;
            background: linear-gradient(180deg, var(--serenity) 0%, var(--rose-quartz) 100%);
            display: flex; justify-content: center; align-items: flex-start;
            padding-top: 10px;
        }

        .container {
            width: 96%; max-width: 1000px;
            height: calc(100dvh - 110px); 
            background: rgba(255, 255, 255, 0.96);
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            padding: 15px;
            display: flex; flex-direction: column;
            position: relative; overflow: hidden;
        }

        .boss-mode .container { border: 5px solid var(--serenity); }
        .boss-mode h1, .boss-mode h2, .boss-mode p, .boss-mode label { color: var(--text-cust); }
        .boss-mode #game-view h1 { color: var(--serenity-dark); }
        .cust-mode .container { border: 5px solid var(--rose-quartz); }
        
        h1 { text-align: center; margin: 5px 0 10px 0; font-size: clamp(1.5rem, 4vw, 2.5rem); color: #444; flex-shrink: 0; }
        h2 { text-align: center; margin: 5px 0; font-size: clamp(1.2rem, 3vw, 1.8rem); color: #555; flex-shrink: 0; }
        .hidden { display: none !important; }
        
        .btn {
            font-size: clamp(1rem, 2.5vw, 1.4rem); padding: 10px 20px; margin: 5px;
            border: none; border-radius: 50px; cursor: pointer; transition: all 0.2s;
            font-weight: bold; box-shadow: 0 3px 5px rgba(0,0,0,0.15);
            display: inline-block; color: white; flex-shrink: 0;
        }
        .btn:active { transform: scale(0.95); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background-color: var(--serenity-dark); }
        .btn-danger { background-color: var(--rose-dark); }
        .btn-success { background-color: #66bb6a; }
        .btn-warning { background-color: #ff9800; } 
        .btn-info { background-color: #607d8b; }
        .btn-light { background-color: #f0f0f0; color: #666; border: 1px solid #ccc; }
        
        .btn-action { 
            font-size: clamp(1.4rem, 4vw, 1.8rem); padding: 12px 60px; 
            margin: 10px auto 0 auto; white-space: nowrap; width: auto; 
            display: block; box-shadow: 0 5px 15px rgba(0,0,0,0.2); flex-shrink: 0;
        }
        .boss-mode .btn-action { background-color: var(--bg-boss-btn); }
        .cust-mode .btn-action { background-color: var(--bg-cust-btn); }

        input, select, textarea {
            font-size: 1.2rem; padding: 8px; margin: 5px 0;
            border-radius: 8px; border: 2px solid #ddd;
            width: 80%; display: block; margin-left: auto; margin-right: auto;
            text-align: center;
        }

        .store-name-input {
            font-size: 1.2rem; font-weight: bold; padding: 5px; width: 200px;
            border: 2px dashed var(--serenity); background: #fff;
            display: inline-block; margin: 0; text-align: left;
            border-radius: 5px; color: #333;
        }
        
        #game-view { display: flex; flex-direction: column; height: 100%; width: 100%; overflow: hidden; }

        .script-bubble {
            flex: 0 0 auto; background: #fff; border-radius: 15px;
            padding: 10px; margin: 5px auto 10px auto;
            font-size: clamp(1.2rem, 3.5vw, 2rem); font-weight: bold; text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); color: #333;
            width: 98%; border: 3px solid; line-height: 1.3;
            min-height: 80px; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .boss-mode .script-bubble { border-color: var(--serenity-dark); color: var(--serenity-dark); }
        .cust-mode .script-bubble { border-color: var(--rose-dark); color: var(--rose-dark); }
        .speech-icon { font-size: 2.5rem; }

        .boss-l5-hint {
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            width: 100%;
            font-size: clamp(0.7rem, 2vw, 1.4rem); 
            color: #555;
            background: #f0f0f0;
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        .card-panel {
            background: rgba(240, 248, 255, 0.5); border: 2px solid #e0e0e0;
            flex: 1 1 auto; padding: 10px; border-radius: 15px; margin-bottom: 5px;
            display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
            text-align: center; overflow-y: auto; -webkit-overflow-scrolling: touch;
            width: 100%; min-height: 0;
        }

        .item-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; width: 100%; padding-bottom: 10px; }
        .item-card {
            background: white; border-radius: 10px; padding: 8px; width: 120px;
            box-shadow: 0 3px 8px rgba(0,0,0,0.1); position: relative;
            cursor: pointer; color: #333; border: 3px solid transparent;
            transition: transform 0.1s; flex-shrink: 0;
        }
        .item-card:active { transform: scale(0.95); }
        .item-card.selected { border-color: var(--rose-dark); background-color: #fff0f0; }
        .item-card.disabled-item { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); background-color: #eee; }

        .item-img { font-size: 3rem; display: block; margin-bottom: 5px; }
        .item-img-real { width: 70px; height: 70px; object-fit: contain; display: block; margin: 0 auto 5px auto; }
        .item-name { font-size: 1.1rem; font-weight: bold; display: block; }
        .item-stock { font-size: 0.9rem; color: #666; display: block;}
        .item-price { color: #d32f2f; font-weight: bold; font-size: 1.2rem; margin-top: 2px;}
        
        .badge-oos { 
            position: absolute; top: 5px; right: 5px; width: auto; height: auto; 
            background: rgba(255, 255, 255, 0.9); border-radius: 5px; padding: 2px 5px;
            color: red; font-size: 1.2rem; font-weight: bold; 
            border: 2px solid red; transform: rotate(15deg);
            z-index: 10;
        }
        .item-card.oos-style .item-img, .item-card.oos-style .item-img-real {
            filter: grayscale(0.8) opacity(0.6);
        }

        .check-item {
            font-size: 1.4rem; margin: 5px; padding: 10px;
            background: white; border-radius: 10px; width: 95%;
            cursor: pointer; display: flex; justify-content: space-between;
            align-items: center; color: #333;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 2px solid #eee;
        }
        .check-item.checked { background: #e8f5e9; color: #2e7d32; border-color: #2e7d32; }
        .check-box { width: 30px; height: 30px; border: 2px solid #ccc; display: inline-block; border-radius: 5px; background:white;}
        .check-item.checked .check-box { background: #2e7d32; border-color: #2e7d32; }
        .check-item.checked .check-box::after { content: 'âœ”'; display:block; color:white; font-size:22px; text-align:center; line-height:28px; }

        .pos-del-btn { background: var(--rose-dark); color: white; border: none; border-radius: 50%; width: 25px; height: 25px; font-size: 0.9rem; font-weight: bold; cursor: pointer; margin-left: 10px; }

        .big-input { 
            font-size: 2.5rem; width: 180px; height: 60px; 
            border: 4px solid var(--serenity-dark); border-radius: 15px; 
            color: #333; background: #fff; text-align: center; 
        }
        
        .math-hint-container { display: flex; align-items: center; justify-content: center; gap: 10px; margin: 10px 0; flex-wrap: wrap; }
        .math-input-group { display: flex; flex-direction: column; align-items: center; }
        .math-label { font-size: 0.9rem; color: #666; margin-bottom: 5px; }
        .math-gap {
            font-size: 1.8rem; width: 100px; padding: 5px;
            border: 2px solid #ccc; border-radius: 5px; text-align: center;
        }
        .math-symbol { font-size: 2rem; font-weight: bold; color: var(--rose-dark); }

        /* Admin Layout */
        #admin-view { display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        .admin-header-area { flex: 0 0 auto; border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        #admin-list-container { flex: 1 1 auto; overflow-y: auto; min-height: 0; padding-right: 5px; }
        .admin-store-box { background: white; padding: 10px 15px; margin: 10px 0; border-radius: 10px; color: #333; text-align: left; border-left: 8px solid var(--serenity); box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .store-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; user-select: none; }
        .store-toggle-icon { font-size: 1.5rem; transition: transform 0.3s; margin-right: 10px; color:#666; }
        .store-items { margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        .store-items.collapsed { display: none; }
        .admin-item-row { display: flex; align-items: center; gap: 5px; border-bottom: 1px solid #f0f0f0; padding: 8px 0; flex-wrap: wrap; }
        .file-upload-btn { font-size: 0.8rem; padding: 5px 10px; background: #f9f9f9; border: 1px solid #ccc; cursor: pointer; border-radius: 5px; }
        .csv-import-box { background: #f0f4f8; border-radius: 10px; padding: 10px; margin-bottom: 10px; border: 2px dashed #92A8D1; }
        .sync-box { background: #e3f2fd; border-radius: 10px; padding: 10px; margin-bottom: 10px; border: 2px solid #92A8D1; display:flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap:10px;}
        
        .oos-row { background: #fff8e1; border: 1px solid #ffcc80; padding: 10px; margin-bottom: 10px; border-radius: 8px; }
        .oos-row label { color: #e65100; font-size: 0.9rem; margin-bottom: 5px; display: block; text-align: left; }

        /* Progress Bar */
        .bottom-progress-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 90px;
            background: white; display: flex; align-items: flex-start;
            justify-content: center; box-shadow: 0 -5px 20px rgba(0,0,0,0.1);
            z-index: 1000; padding-top: 10px;
        }
        .progress-track-container {
            position: absolute; bottom: 25px; left: 0; right: 0; height: 8px; 
            margin: 0 calc(100% / var(--step-count) / 2); z-index: 0;
        }
        .progress-track-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #eee; border-radius: 4px; }
        .progress-track-fill {
            position: absolute; top: 0; left: 0; height: 100%; width: 0%;
            background: var(--gradient-bar); border-radius: 4px;
            transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 0 10px rgba(146, 168, 209, 0.5);
        }
        .progress-step {
            flex: 1; text-align: center; position: relative; z-index: 1; height: 100%;
            display: flex; flex-direction: column; justify-content: flex-start;
        }
        .progress-step span {
            font-size: 1.1rem; color: #bbb; font-weight: bold; display: block;
            margin-top: 5px; transition: color 0.3s;
        }
        .progress-step::after {
            content: ''; width: 20px; height: 20px; background: #ddd; border-radius: 50%;
            position: absolute; bottom: 19px; left: 50%; transform: translateX(-50%);
            border: 3px solid white; transition: all 0.4s; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .progress-step.active span { color: var(--serenity-dark); transform: scale(1.1); }
        .progress-step.active::after { background: var(--rose-dark); transform: translateX(-50%) scale(1.3); box-shadow: 0 0 10px var(--rose-quartz); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000; display: flex;
            justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .modal-box {
            background: white; padding: 40px; border-radius: 20px;
            width: 80%; max-width: 500px; text-align: left;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;
        }
        .modal-box h3 { text-align: center; }
        
        #setup-scroll-area { flex: 1; overflow-y: auto; padding: 5px; min-height: 0; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 5px; vertical-align: middle; }
        .status-offline { background-color: #ccc; }
        .status-online { background-color: #4caf50; box-shadow: 0 0 5px #4caf50; }
        .status-connecting { background-color: #ff9800; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .tutorial-step { margin-bottom: 15px; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
        .code-block { background: #f5f5f5; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.8rem; word-break: break-all; border: 1px solid #ddd; margin-top: 5px;}
    </style>
</head>
<body id="body-tag">

<div class="container" id="app">
    <div id="home-view">
        <h1 style="color:#444; font-size: 3rem; margin-top: 10vh; font-weight:900;">æˆ‘æ˜¯è³¼ç‰©å°é”äºº</h1>
        <br>
        <div style="display:flex; flex-direction:column; align-items:center; gap:20px;">
            <button class="btn btn-primary" style="width:280px; padding:20px; font-size:1.5rem;" onclick="promptPassword('game')">ğŸ® é–‹å§‹éŠæˆ²</button>
            <button class="btn btn-danger" style="width:280px; padding:20px; font-size:1.5rem;" onclick="promptPassword('admin')">ğŸ› ï¸ å•†åº—å¾Œå°ç®¡ç†</button>
        </div>
    </div>

    <div id="setup-view" class="hidden" style="display:flex; flex-direction:column; height:100%;">
        <h2 style="color:#444; font-size:2rem; border-bottom: 2px solid #eee; padding-bottom:10px; flex-shrink:0;">âš™ï¸ èª²ç¨‹è¨­å®š</h2>
        
        <div id="setup-scroll-area">
            <label>1. é¸æ“‡å•†åº— (é›™æ©Ÿéœ€ä¸€è‡´)ï¼š</label>
            <select id="store-select" onchange="updateOOSSelector()"></select>
            <label>2. é¸æ“‡åŠ‡æœ¬ (é›™æ©Ÿéœ€ä¸€è‡´)ï¼š</label>
            <select id="level-select" onchange="updateSetupUI()">
                <option value="1">Level 1ï¼šè‡ªç”±é¸è³¼ (åŸºç¤)</option>
                <option value="2">Level 2ï¼šæ¸…å–®è³¼ç‰© (è¦–è¦ºæŒ‡å®š)</option>
                <option value="3">Level 3ï¼šè‡ªç”±é»é¤ (POS/è½è¦º)</option>
                <option value="4">Level 4ï¼šæŒ‡å®šé»é¤ (POS/è¦–è¦ºä»»å‹™)</option>
                <option value="5">Level 5ï¼šç¼ºè²¨æ›¿ä»£ (æ‡‰è®Š)</option>
                <option value="6">Level 6ï¼šé­”ç‹æ··åˆ (éš¨æ©Ÿ)</option>
            </select>
            <div id="setup-quantity">
                <label id="quantity-label">3. æœ¬å›åˆè¦è²·å¹¾æ¨£å•†å“ï¼Ÿ</label>
                <input type="number" id="item-quantity" value="2" min="1" max="5">
            </div>
            
            <!-- Level 5 å°ˆç”¨è¨­å®š -->
            <div id="setup-oos-area" class="hidden" style="background:#fff3e0; padding:10px; border-radius:10px; border:2px dashed #ff9800; margin:5px 0;">
                <label style="color:#e65100;">ğŸš¨ æŒ‡å®šç¼ºè²¨æ•¸é‡ï¼š</label>
                <input type="number" id="oos-count" value="1" min="1" max="3" onchange="updateOOSSelector()">
                
                <div id="oos-pairs-container" style="margin-top:10px;"></div>

                <hr style="border-top:1px dashed #ffb74d;">
                <label style="color:#e65100;">ğŸ¤” ç¼ºè²¨æ™‚å®¢äººçš„å›æ‡‰æ–¹å¼ï¼š</label>
                <select id="alt-response-mode">
                    <option value="specific">é‚£è«‹å•æœ‰ [æ›¿ä»£å“] å—ï¼Ÿ (ç°¡å–®/ç›´æ¥å¼•å°)</option>
                    <option value="open">è«‹å•é‚„æœ‰ä»€éº¼ï¼Ÿ (é€²éš/ç¤¾äº¤æ‡‰å°)</option>
                </select>
            </div>

            <div id="setup-duplicate" class="hidden">
                <label>4. æ¸…å–®å“é …æ˜¯å¦å¯é‡è¤‡ï¼Ÿ</label>
                <select id="allow-duplicate">
                    <option value="no">ä¸é‡è¤‡</option>
                    <option value="yes">å¯é‡è¤‡</option>
                </select>
            </div>
            <label>è¨­å®šæœ¬å¹³æ¿è§’è‰²ï¼š</label>
            <select id="role-select" onchange="updateSetupUI()">
                <option value="boss">æˆ‘æ˜¯è€é—†</option>
                <option value="cust">æˆ‘æ˜¯å®¢äºº</option>
            </select>
            <div id="boss-settings" class="hidden">
                <label>æ•¸å­¸é›£åº¦ï¼š</label>
                <select id="math-diff">
                    <option value="10">10ä»¥å…§åŠ æ¸›</option>
                    <option value="100s">100ä»¥å…§ä¸é€²é€€</option>
                    <option value="100h">100ä»¥å…§é€²é€€ä½</option>
                    <option value="mix">æ··åˆæ¨¡å¼</option>
                </select>
                <!-- æ–°å¢ï¼šæ‰¾éŒ¢ç®—å¼æç¤ºè¨­å®š -->
                <label style="color:var(--rose-dark); font-weight:bold;">æ‰¾éŒ¢ç®—å¼æç¤ºï¼š</label>
                <select id="math-hint-mode">
                    <option value="direct">æ¨¡å¼Aï¼šç›´æ¥çµ¦ç®—å¼ (100-76=__)</option>
                    <option value="fill">æ¨¡å¼Bï¼šéœ€å¡«ç©º (___-___=___)</option>
                </select>
            </div>
            <div id="cust-settings" class="hidden">
                <div id="menu-setting" class="hidden">
                    <label>æ˜¯å¦é¡¯ç¤ºåœ–ç‰‡èœå–® (L3å°ˆç”¨)ï¼š</label>
                    <select id="show-menu">
                        <option value="yes">é¡¯ç¤ºèœå–®</option>
                        <option value="no">éš±è— (è½è¦ºè¨˜æ†¶)</option>
                    </select>
                </div>
            </div>
        </div>
        <div style="display:flex; justify-content:center; margin-top: 10px; gap: 10px; padding-bottom: 5px; flex-shrink:0;">
            <button class="btn btn-primary" onclick="startGame()">ğŸš€ é€²å…¥è³£å ´</button>
            <button class="btn btn-danger" onclick="backToHome()">ğŸ  è¿”å›é¦–é </button>
        </div>
    </div>

    <!-- éŠæˆ²ä¸»ç•«é¢ -->
    <div id="game-view" class="hidden">
        <div id="script-area" class="script-bubble hidden"></div>
        <div id="card-area" class="card-panel"></div>
        <button id="main-action-btn" class="btn btn-action" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
    </div>

    <!-- å¾Œå°ç®¡ç† -->
    <div id="admin-view" class="hidden">
        <div class="admin-header-area">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2 style="color:#444; margin:0;">ğŸ“¦ å•†åº—å¾Œå°ç®¡ç†</h2>
                <div style="font-size:0.9rem; color:#666; display:flex; align-items:center;">
                    <span id="cloud-status-dot" class="status-dot status-offline"></span>
                    <span id="cloud-status-text">æœªé€£ç·š</span>
                </div>
            </div>
            
            <div class="sync-box">
                <span style="font-weight:bold; color:#555; width:100%; text-align:center;">ğŸ”„ è·¨è£ç½®è³‡æ–™è½‰ç§»</span>
                <button class="btn btn-success" style="font-size:0.9rem; padding:8px 15px; margin:0;" onclick="exportJSON()">ğŸ“¤ åŒ¯å‡ºæœ¬æ©Ÿè³‡æ–™ (å‚™ä»½)</button>
                <label class="btn btn-warning" style="font-size:0.9rem; padding:8px 15px; margin:0; cursor:pointer;">
                    ğŸ“¥ åŒ¯å…¥è³‡æ–™ (è¦†è“‹æœ¬æ©Ÿ)
                    <input type="file" accept=".json" style="display:none" onchange="importJSON(this)">
                </label>
                <button class="btn btn-light" style="font-size:0.8rem; padding:5px 10px;" onclick="openConfigModal()">â˜ï¸ é€²éšé›²ç«¯è¨­å®š</button>
            </div>

            <div class="csv-import-box">
                <h4 style="margin:5px 0;">ğŸ“ æ‰¹é‡æ–°å¢å•†å“ (CSV)</h4>
                <div style="display:flex; justify-content:center; gap:10px; align-items:center; flex-wrap:wrap;">
                    <button class="btn" style="font-size:0.9rem; padding:5px 10px; background:#fff; color:#333; border:1px solid #ccc;" onclick="downloadSampleCSV()">â¬‡ï¸ ä¸‹è¼‰ç¯„ä¾‹</button>
                    <label class="btn btn-primary" style="font-size:0.9rem; padding:5px 10px; cursor:pointer;">
                        ğŸ“‚ é¸æ“‡CSV
                        <input type="file" accept=".csv" style="display:none" onchange="processCSV(this)">
                    </label>
                </div>
                <p style="font-size:0.8rem; color:#666; margin:5px 0 0 0;">æ ¼å¼ï¼šå•†åº—åç¨±,å•†å“åç¨±,åº«å­˜</p>
            </div>
            
            <div style="text-align:center; display:flex; justify-content:center; gap:5px; flex-wrap:wrap; margin-top:10px;">
                 <button class="btn btn-success" style="font-size:1rem; padding:8px 15px;" onclick="addNewStore()">+ æ–°å¢å•†åº—</button>
                 <button class="btn btn-primary" style="font-size:1rem; padding:8px 15px;" onclick="resetDefaultData()">é‡ç½®è³‡æ–™</button>
                 <button class="btn btn-danger" style="font-size:1rem; padding:8px 15px;" onclick="backToHome()">è¿”å›</button>
            </div>
        </div>
        <div id="admin-list-container">
            <div id="admin-list"></div>
        </div>
    </div>
</div>

<div id="progress-bar" class="bottom-progress-bar hidden"></div>

<div id="pwd-modal" class="modal-overlay hidden">
    <div class="modal-box" style="text-align:center;">
        <h3 style="font-size:1.8rem; margin-bottom:20px;">ğŸ”’ è«‹è¼¸å…¥å¯†ç¢¼</h3>
        <input type="password" id="modal-pwd-input" style="font-size:2rem; width:100%; margin-bottom:20px;">
        <br>
        <button class="btn btn-primary" onclick="checkPassword()">ç¢ºèª</button>
        <button class="btn btn-danger" onclick="closeModal()">å–æ¶ˆ</button>
    </div>
</div>

<div id="config-modal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3 style="margin-top:0;">â˜ï¸ é€²éšï¼šGoogle Firebase é€£ç·š</h3>
        <p style="font-size:0.9rem; color:#666;">è‹¥æ‚¨æ‡‚å¾—è¨­å®š Google Firebase Firestoreï¼Œå¯åœ¨æ­¤è²¼ä¸Šè¨­å®šæª”ä»¥å•Ÿç”¨å³æ™‚åŒæ­¥ã€‚</p>
        <textarea id="firebase-config-input" rows="6" style="width:100%; font-size:0.8rem; border:2px solid #ccc; padding:5px; border-radius:5px;" placeholder='åœ¨æ­¤è²¼ä¸Š firebaseConfig JSON (ä¾‹å¦‚: {"apiKey": "...", ...})'></textarea>
        <p id="config-error-msg" style="color:red; font-size:0.8rem; display:none;">æ ¼å¼éŒ¯èª¤æˆ–é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–ä»£ç¢¼ã€‚</p>
        <br><br>
        <button class="btn btn-success" onclick="saveFirebaseConfig()">ğŸ”— é€£ç·šä¸¦å„²å­˜</button>
        <button class="btn btn-danger" onclick="document.getElementById('config-modal').classList.add('hidden')">é—œé–‰</button>
    </div>
</div>

<script>
// --- Global State ---
const defaultStores = [
    {id:'s1', name:'ç¾å‘³æ¼¢å ¡åº—', items:[{id:1, name:'æ¼¢å ¡', icon:'ğŸ”', imgType:'icon', stock:5}, {id:2, name:'è–¯æ¢', icon:'ğŸŸ', imgType:'icon', stock:5}, {id:3, name:'å¯æ¨‚', icon:'ğŸ¥¤', imgType:'icon', stock:5}, {id:4, name:'é›å¡Š', icon:'ğŸ—', imgType:'icon', stock:0}]},
    {id:'s2', name:'é™½å…‰æ–‡å…·åº—', items:[{id:1, name:'é‰›ç­†', icon:'âœï¸', imgType:'icon', stock:10}, {id:2, name:'æ©¡çš®æ“¦', icon:'ğŸŸ¦', imgType:'icon', stock:10}, {id:3, name:'ç­†è¨˜æœ¬', icon:'ğŸ““', imgType:'icon', stock:5}, {id:4, name:'å‰ªåˆ€', icon:'âœ‚ï¸', imgType:'icon', stock:5}]},
    {id:'s3', name:'å¿«æ¨‚ä¾¿åˆ©å•†åº—', items:[{id:1, name:'ç‰›å¥¶', icon:'ğŸ¥›', imgType:'icon', stock:5}, {id:2, name:'éºµåŒ…', icon:'ğŸ', imgType:'icon', stock:5}]},
    {id:'s4', name:'ç”œèœœéºµåŒ…åº—', items:[{id:1, name:'ç”œç”œåœˆ', icon:'ğŸ©', imgType:'icon', stock:5}, {id:2, name:'è›‹ç³•', icon:'ğŸ°', imgType:'icon', stock:5}]},
    {id:'s5', name:'å¤¢æƒ³ç©å…·åº—', items:[{id:1, name:'æ©Ÿå™¨äºº', icon:'ğŸ¤–', imgType:'icon', stock:2}, {id:2, name:'å°ç†Š', icon:'ğŸ§¸', imgType:'icon', stock:2}]}
];

let stores = []; let session = {}; let db = null; let useCloud = false; let targetView = '';

// --- Init ---
function initApp() {
    const configStr = localStorage.getItem('firebase_config_custom');
    if (configStr) { try { updateCloudStatus('connecting'); initFirebase(JSON.parse(configStr)); } catch(e) { console.error("Config Error", e); loadLocalStores(); } } 
    else { loadLocalStores(); }
}
function initFirebase(config) { if (!firebase.apps.length) firebase.initializeApp(config); db = firebase.firestore(); subscribeToStores(); }
function updateCloudStatus(status) { const dot = document.getElementById('cloud-status-dot'); const text = document.getElementById('cloud-status-text'); if(status === 'online') { dot.className = "status-dot status-online"; text.innerText = "å·²é€£ç·šåŒæ­¥ä¸­"; } else if (status === 'connecting') { dot.className = "status-dot status-connecting"; text.innerText = "é€£ç·šä¸­..."; } else { dot.className = "status-dot status-offline"; text.innerText = "æœªé€£ç·š (æœ¬æ©Ÿæ¨¡å¼)"; } }
function loadLocalStores() { stores = JSON.parse(localStorage.getItem('stores')) || JSON.parse(JSON.stringify(defaultStores)); updateCloudStatus('offline'); }
function subscribeToStores() { db.collection('shopping_data').doc('main').onSnapshot(doc => { useCloud = true; updateCloudStatus('online'); if (doc.exists) { stores = doc.data().stores; refreshUI(); } else { saveStoresToCloud(); } }, error => { console.error("Cloud Error:", error); useCloud = false; updateCloudStatus('offline'); if(stores.length === 0) loadLocalStores(); }); }
function refreshUI() { if (!document.getElementById('setup-view').classList.contains('hidden')) { const sel = document.getElementById('store-select'); const curr = sel.value; sel.innerHTML = stores.map(s => `<option value="${s.id}">${s.name}</option>`).join(''); if(curr && stores.find(s=>s.id===curr)) sel.value = curr; else if(stores.length > 0) sel.value = stores[0].id; updateOOSSelector(); } if (!document.getElementById('admin-view').classList.contains('hidden')) renderAdminList(); }
function saveStores() { if (useCloud && db) saveStoresToCloud(); else localStorage.setItem('stores', JSON.stringify(stores)); }
function saveStoresToCloud() { db.collection('shopping_data').doc('main').set({ stores: stores }).catch(e => { console.error("Save failed", e); alert("å„²å­˜å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šã€‚"); }); }
function compressImage(base64Str, maxWidth = 300, quality = 0.6) { return new Promise((resolve) => { const img = new Image(); img.src = base64Str; img.onload = () => { const canvas = document.createElement('canvas'); let w = img.width, h = img.height; if (w > maxWidth) { h = Math.round((h * maxWidth) / w); w = maxWidth; } canvas.width = w; canvas.height = h; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h); resolve(canvas.toDataURL('image/jpeg', quality)); }; }); }

// --- UI Logic ---
function promptPassword(target) { targetView = target; document.getElementById('modal-pwd-input').value = ''; document.getElementById('pwd-modal').classList.remove('hidden'); document.getElementById('modal-pwd-input').focus(); }
function closeModal() { document.getElementById('pwd-modal').classList.add('hidden'); }
function checkPassword() { if (document.getElementById('modal-pwd-input').value === '1005') { closeModal(); if (targetView === 'game') renderSetup(); else if (targetView === 'admin') showAdmin(); } else { alert('å¯†ç¢¼éŒ¯èª¤'); document.getElementById('modal-pwd-input').value = ''; } }
function openConfigModal() { document.getElementById('config-modal').classList.remove('hidden'); document.getElementById('firebase-config-input').value = localStorage.getItem('firebase_config_custom') || ''; }
function saveFirebaseConfig() { try { const config = JSON.parse(document.getElementById('firebase-config-input').value); if(!config.apiKey || !config.projectId) throw new Error("Invalid Config"); localStorage.setItem('firebase_config_custom', JSON.stringify(config)); location.reload(); } catch(e) { document.getElementById('config-error-msg').style.display = 'block'; } }
function exportJSON() { const blob = new Blob([JSON.stringify(stores)], {type: "application/json"}); const link = document.createElement('a'); link.href = URL.createObjectURL(blob); link.download = `shopping_data_${new Date().toISOString().slice(0,10)}.json`; link.click(); }
function importJSON(input) { if(!input.files[0]) return; const r = new FileReader(); r.onload = function(e) { try { const data = JSON.parse(e.target.result); if(Array.isArray(data)) { stores = data; saveStores(); renderAdminList(); alert("åŒ¯å…¥æˆåŠŸï¼"); } else { alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤"); } } catch(err) { alert("æª”æ¡ˆææ¯€æˆ–æ ¼å¼éŒ¯èª¤"); } input.value = ''; }; r.readAsText(input.files[0]); }
function backToHome() { hideAll(); document.getElementById('home-view').classList.remove('hidden'); document.getElementById('body-tag').className = ''; document.getElementById('progress-bar').classList.add('hidden'); }
function renderSetup() { hideAll(); document.getElementById('setup-view').classList.remove('hidden'); document.getElementById('store-select').innerHTML = stores.map(s => `<option value="${s.id}">${s.name}</option>`).join(''); updateSetupUI(); }

function updateSetupUI() {
    const role = document.getElementById('role-select').value;
    const level = document.getElementById('level-select').value;
    role==='boss'?(document.getElementById('boss-settings').classList.remove('hidden'),document.getElementById('cust-settings').classList.add('hidden')):(document.getElementById('boss-settings').classList.add('hidden'),document.getElementById('cust-settings').classList.remove('hidden'),level==='3'?document.getElementById('menu-setting').classList.remove('hidden'):document.getElementById('menu-setting').classList.add('hidden'));
    
    const qLabel = document.getElementById('quantity-label');
    const dupSetting = document.getElementById('setup-duplicate');
    const oosArea = document.getElementById('setup-oos-area');

    if(['1','3'].includes(level)) { qLabel.innerText="3. æœ¬å›åˆè¦è²·å¹¾æ¨£å•†å“/é…èœï¼Ÿ(è‡ªç”±é¸)"; dupSetting.classList.add('hidden'); }
    else { qLabel.innerText="3. è³¼ç‰©æ¸…å–®è¦æŒ‡å®šå¹¾æ¨£å•†å“ï¼Ÿ(ç³»çµ±æŠ½)"; dupSetting.classList.remove('hidden'); }

    if(level === '5') {
        oosArea.classList.remove('hidden');
        updateOOSSelector();
    } else {
        oosArea.classList.add('hidden');
    }
}

function updateOOSSelector() {
    const storeId = document.getElementById('store-select').value;
    const store = stores.find(s => s.id === storeId);
    const count = parseInt(document.getElementById('oos-count').value) || 1;
    const container = document.getElementById('oos-pairs-container');
    container.innerHTML = '';
    
    if(store) {
        for(let i=1; i<=count; i++) {
            let options = store.items.map(item => `<option value="${item.id}">${item.name}</option>`).join('');
            // æ›¿ä»£å“é è¨­é¸ä¸åŒçš„
            let altOptions = store.items.map((item, idx) => `<option value="${item.id}" ${idx===i?'selected':''}>${item.name}</option>`).join('');
            
            let html = `
            <div class="oos-row">
                <label>ç¬¬ ${i} çµ„ï¼šç¼ºè²¨å•†å“ â†’ æ›¿ä»£å•†å“</label>
                <div style="display:flex; gap:5px;">
                    <select id="oos-item-${i}" style="flex:1;">${options}</select>
                    <span>â¡</span>
                    <select id="alt-item-${i}" style="flex:1;">${altOptions}</select>
                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
        }
    }
}

function startGame() {
    const store = stores.find(s => s.id === document.getElementById('store-select').value);
    if(!store) { alert("å•†åº—è³‡æ–™éŒ¯èª¤"); return; }
    
    const level = document.getElementById('level-select').value;
    let qty = parseInt(document.getElementById('item-quantity').value);
    const allowDuplicate = document.getElementById('allow-duplicate').value === 'yes';

    session = {
        store: store, level: level, role: document.getElementById('role-select').value,
        step: 1, itemsToBuy: [], cart: [], bossInputPrice: null, bossInputReceived: null, bossInputChange: null,
        mathDiff: document.getElementById('math-diff').value, mathHintMode: document.getElementById('math-hint-mode').value,
        showMenu: document.getElementById('show-menu').value === 'yes', qty: qty,
        altResponseMode: document.getElementById('alt-response-mode').value,
        oosPairs: []
    };

    let usedPrices = [];
    session.store.items.forEach(item => { item.price = getUniquePrice(session.mathDiff, usedPrices); usedPrices.push(item.price); });

    if(level === '5') {
        const oosCount = parseInt(document.getElementById('oos-count').value);
        let specifiedOOSIds = [];
        
        for(let i=1; i<=oosCount; i++) {
            let oosId = document.getElementById(`oos-item-${i}`).value;
            let altId = document.getElementById(`alt-item-${i}`).value;
            let oosItem = store.items.find(x=>x.id==oosId);
            let altItem = store.items.find(x=>x.id==altId);
            
            if(oosItem && altItem && oosItem.id === altItem.id) {
                 let other = store.items.find(x=>x.id !== oosItem.id);
                 if(other) altItem = other;
            }

            if(oosItem && altItem) {
                session.oosPairs.push({oos: oosItem, alt: altItem});
                specifiedOOSIds.push(oosItem.id);
            }
        }
        
        let minQty = session.oosPairs.length + 1; // è‡³å°‘1å€‹æœ‰è²¨
        if(qty < minQty) { qty = minQty; session.qty = minQty; }

        session.itemsToBuy = session.oosPairs.map(p => p.oos); 
        
        let pool = store.items.filter(i => !specifiedOOSIds.includes(i.id));
        let needMore = qty - session.itemsToBuy.length;
        
        for(let k=0; k<needMore; k++) {
            if(pool.length === 0 && !allowDuplicate) break;
            let idx = Math.floor(Math.random() * pool.length);
            session.itemsToBuy.push(pool[idx]);
            if(!allowDuplicate) pool.splice(idx, 1);
        }

    } else if(['2','4','6'].includes(level)) {
        let pool = session.store.items.filter(i => i.stock > 0);
        if(pool.length === 0) { alert("æ­¤å•†åº—æ²’æœ‰åº«å­˜>0çš„å•†å“ï¼"); return; }
        if(!allowDuplicate && qty > pool.length) { session.qty = pool.length; qty = pool.length; }
        for(let i=0; i<qty; i++) {
            if(!allowDuplicate && pool.length === 0) break;
            let idx = Math.floor(Math.random() * pool.length);
            session.itemsToBuy.push(pool[idx]);
            if(!allowDuplicate) pool.splice(idx, 1);
        }
    }

    document.getElementById('body-tag').className = session.role === 'boss' ? 'boss-mode' : 'cust-mode';
    hideAll(); document.getElementById('game-view').classList.remove('hidden');
    renderProgressBar(); renderStep();
}

function getUniquePrice(diff, used) {
    let p, att=0; do { p=diff==='10'?Math.floor(Math.random()*9)+1:Math.floor(Math.random()*45)+5; att++; if(diff==='10'){if(used.filter(x=>x===p).length<3)break;}else{if(!used.includes(p))break;} } while(att<20); return p;
}

function nextStep() { if(validateCurrentStep()) { session.step++; renderStep(); updateProgressBar(); } }

function validateCurrentStep() {
    if(session.role === 'cust' && session.level === '2' && session.step === 1 && document.querySelectorAll('.check-item:not(.checked)').length > 0) { alert("è«‹å…ˆå°‡æ¸…å–®ä¸Šçš„å•†å“éƒ½æ‰“å‹¾ï¼"); return false; }
    
    if(session.role === 'boss') {
        const checkVal = (id, checkFn) => {
            const el = document.getElementById(id); if(!el) return true;
            const val = parseInt(el.value); if(isNaN(val)) { alert("è«‹è¼¸å…¥æ•¸å­—"); return false; }
            return checkFn ? checkFn(val) : true;
        };

        // Step 2: Quote (Unified logic for all levels)
        // Note: For L1/L2, we allow any input (manual check). For L3/4/5 (POS/Predefined), we can strictly check.
        if (session.step === 2) {
            return checkVal('boss-input-total', v => {
                // For L3, L4, L5, we know the exact cart/list, so strict check
                if(['3','4'].includes(session.level) || session.level === '5') {
                    // For L5, calculation is tricky because boss adds alt items manually in step 1?
                    // Actually in L5 Step 1 boss clicks POS. So cart is accurate.
                    // But in v29, L5 Step 2 logic calculates "correct" based on OOS logic, NOT cart.
                    // In v30, we must ensure boss clicks in Step 1 match.
                    // For simplicity, let's trust what's in session.cart for POS levels (L3/4/5)
                    // Wait, L5 Step 1 is "POS & OOS Interaction". Boss clicks items.
                    // So session.cart has the actual items.
                    // If boss didn't click anything? Then total is 0.
                    let correct = 0;
                    if(session.cart.length > 0) correct = session.cart.reduce((a,b)=>a+b.price, 0);
                    // If cart is empty, maybe alert?
                    if(session.cart.length === 0 && ['3','4','5'].includes(session.level)) {
                        alert("è«‹å…ˆåœ¨POSæ©Ÿé»é¸å•†å“ï¼"); return false;
                    }
                    if(v !== correct) { alert("ä¸å°å–”ï¼Œæˆ‘å€‘å†è©¦è©¦çœ‹"); return false; }
                }
                session.bossInputPrice = v;
                return true;
            });
        }
        
        // Step 3: Pay
        if(session.step === 3) {
            return checkVal('boss-input-received', v => {
                if(v < session.bossInputPrice) { alert("éŒ¢ä¸å¤ å–”ï¼Œè«‹å®¢äººå†æ‹¿å¤šä¸€é»"); return false; }
                session.bossInputReceived=v; return true;
            });
        }

        // Step 4: Change
        if(session.step === 4) {
            if(session.mathHintMode === 'fill' && document.getElementById('calc-paid')) {
                const p = parseInt(document.getElementById('calc-paid').value);
                const t = parseInt(document.getElementById('calc-total').value);
                if(p !== session.bossInputReceived || t !== session.bossInputPrice) { alert("ç®—å¼å¡«éŒ¯å›‰ï¼"); return false; }
            }
            return checkVal('boss-input-change', v => {
                if(v !== session.bossInputReceived - session.bossInputPrice) { alert("ä¸å°å–”ï¼Œæˆ‘å€‘å†è©¦è©¦çœ‹"); return false; }
                session.bossInputChange=v; return true;
            });
        }
    }
    return true;
}

function renderStep() {
    const btn = document.getElementById('main-action-btn');
    btn.onclick = nextStep; btn.classList.remove('btn-success'); btn.innerText = "ä¸‹ä¸€æ­¥";
    const container = document.getElementById('card-area');
    const scriptBubble = document.getElementById('script-area');
    container.innerHTML = ''; scriptBubble.classList.remove('hidden');

    if(session.step === 0) return; 

    if(session.level === '5') renderLevel5(container, scriptBubble, btn);
    else if(['3','4'].includes(session.level)) renderLevel3_4(container, scriptBubble, btn);
    else renderLevel1_2(container, scriptBubble, btn);
    
    let maxStep = session.level === '5' ? 4 : 4; 
    if (session.step > maxStep) renderEndScreen(container, scriptBubble, btn);
}

// L1 & L2
function renderLevel1_2(container, scriptBubble, btn) {
    if(session.step === 1) {
        if(session.role === 'boss') {
            scriptBubble.classList.add('hidden'); container.innerHTML = `<h1>â³</h1><h2>å®¢äººæ­£åœ¨é¸å•†å“ï¼Œè«‹ç­‰å¾…...</h2>`; btn.innerText = "å®¢äººæ‹¿å•†å“çµ¦æˆ‘äº†";
        } else {
            if(session.level === '2') {
                scriptBubble.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> æˆ‘è¦è²·é€™äº› (çœ‹æ¸…å–®)`;
                container.innerHTML = `<h2>ğŸ“‹ è³¼ç‰©æ¸…å–®æª¢æ ¸</h2>${session.itemsToBuy.map(i=>`<div class="check-item" onclick="this.classList.toggle('checked')">${renderItemImg(i,'small')}<span>${i.name}</span><div class="check-box"></div></div>`).join('')}`;
            } else {
                scriptBubble.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> æˆ‘è¦å»æŒ‘å–œæ­¡çš„æ±è¥¿`;
                container.innerHTML = `<h2>ğŸ›ï¸ æŒ‡ä»¤</h2><p style="font-size:2rem">è«‹æŒ‘é¸ä½ å–œæ­¡çš„ <span style="color:var(--rose-dark); font-weight:bold; font-size:2.5rem;">ã€Œ${session.qty}ã€</span> æ¨£å•†å“æ‹¿çµ¦è€é—†</p>`;
            }
            btn.innerText = "æˆ‘æŒ‘å¥½äº†ï¼Œæ‹¿çµ¦è€é—†";
        }
    } else if(session.step === 2) {
        if(session.role !== 'boss') {
            scriptBubble.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> è€é—†ï¼Œè«‹å•å¤šå°‘éŒ¢ï¼Ÿ`; container.innerHTML = `<h1>ğŸ—£ï¸</h1><p>è«‹å¤§è²è©¢å•è€é—†</p>`; btn.innerText = "èªªå®Œäº†";
        } else {
            scriptBubble.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> ç¸½å…± [ ? ] å…ƒ`;
            container.innerHTML = `<h2>ğŸ“‹ åƒ¹ç›®è¡¨ (è¨ˆç®—ä¸¦å ±åƒ¹)</h2><div class="item-grid">${session.store.items.map(i=>`<div class="item-card">${renderItemImg(i)}<span class="item-name">${i.name}</span><span class="item-price">$${i.price}</span></div>`).join('')}</div><hr style="width:90%;margin:15px 0;"><label>ç¸½å…±å¹¾å…ƒï¼Ÿ</label><input type="number" id="boss-input-total" class="big-input" placeholder="?" oninput="updateBubblePrice(this.value)">`;
            btn.innerText = "å ±åƒ¹å®Œç•¢ï¼Œæº–å‚™æ”¶éŒ¢";
        }
    } else if(session.step === 3) {
        renderCommonCheckout(3, container, scriptBubble, btn);
    } else if(session.step === 4) {
        renderCommonCheckout(4, container, scriptBubble, btn);
    }
}

// L3 & L4
function renderLevel3_4(container, scriptBubble, btn) {
    if(session.step === 1) { // Order/POS
        if(session.role === 'boss') {
            scriptBubble.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> å¥½çš„ï¼Œæˆ‘å¹«ä½ é»é¤`; renderPOS(container); btn.innerText = "é»é¤å®Œç•¢ï¼Œçµå¸³";
        } else {
            if(session.level === '4') {
                scriptBubble.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> è€é—†ï¼Œæˆ‘è¦é»...(å”¸å‡ºæ¸…å–®)`;
                container.innerHTML = `<h2>ğŸ“ é»é¤ä»»å‹™</h2>${session.itemsToBuy.map(i=>`<div style="font-size:1.5rem; margin:10px;">ğŸ”¹ ${i.name}</div>`).join('')}`;
            } else {
                scriptBubble.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> è€é—†ï¼Œæˆ‘è¦é»...(è‡ªå·±æ±ºå®š)`;
                let menuHtml = session.showMenu?session.store.items.map(i=>`<div style="display:inline-block; margin:10px; text-align:center;">${renderItemImg(i,'small')}<br>${i.name}</div>`).join(''):"<h2>ğŸ‘‚ (ç„¡èœå–®æ¨¡å¼)</h2>";
                container.innerHTML = `<h2>ğŸ¤” è«‹æŒ‘é¸ <span style="color:var(--rose-dark); font-weight:bold;">ã€Œ${session.qty}ã€</span> æ¨£é¤é»</h2><div>${menuHtml}</div>`;
            }
            btn.innerText = "é»å®Œäº†";
        }
    } else if(session.step === 2) { // Quote
        if(session.role !== 'boss') {
            scriptBubble.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> è«‹å•å¤šå°‘éŒ¢ï¼Ÿ`; container.innerHTML = `<h1>ğŸ—£ï¸</h1>`; btn.innerText = "èªªå®Œäº†";
        } else {
            scriptBubble.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> ç¸½å…± [ ? ] å…ƒ`;
            // Recalculate cart total for display
            let listHtml = session.cart.map(c => `<li>${c.name} $${c.price}</li>`).join('');
            container.innerHTML = `<h2>ğŸ§¾ è¨‚å–®ç¢ºèª</h2><ul style="text-align:left; font-size:1.4rem;">${listHtml}</ul><hr><label>è«‹è¨ˆç®—ä¸¦è¼¸å…¥ç¸½é¡ï¼š</label><input type="number" id="boss-input-total" class="big-input" placeholder="?" oninput="updateBubblePrice(this.value)">`;
            btn.innerText = "å ±åƒ¹å®Œç•¢ï¼Œæº–å‚™æ”¶éŒ¢";
        }
    } else if(session.step === 3) {
        renderCommonCheckout(3, container, scriptBubble, btn);
    } else if(session.step === 4) {
        renderCommonCheckout(4, container, scriptBubble, btn);
    }
}

// L5
function renderLevel5(container, scriptBubble, btn) {
    if(session.step === 1) { // Order & POS Interaction (Answer OOS/Alt)
        if(session.role === 'boss') {
            let hint = session.oosPairs.map(p => `${p.oos.name}âŒ â¡ ${p.alt.name}â­•`).join('ã€');
            scriptBubble.innerHTML = `<div class="boss-l5-hint" title="${hint}"><span class="speech-icon">ğŸ—£ï¸</span> æç¤ºï¼š${hint}</div><div style="font-size:1.2rem; color:#666;">(è«‹é»æ“ŠPOSæ©Ÿå›ç­”å®¢äºº)</div>`;
            renderPOS(container); 
            btn.innerText = "é»é¤å®Œç•¢ï¼Œçµå¸³";
        } else {
            // Guest sees list including OOS
            let names = session.itemsToBuy.map(i => i.name).join("ã€");
            scriptBubble.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> è€é—†ï¼Œæˆ‘è¦è²· ${names}`; 
            container.innerHTML = `
                <h2>ğŸ›ï¸ è³¼ç‰©æ¸…å–®</h2>
                <div style="display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
                    ${session.itemsToBuy.map(i => `<div class="item-card">${renderItemImg(i)}<span class="item-name">${i.name}</span></div>`).join('')}
                </div>
            `;
            btn.innerText = "èªªå®Œäº†";
        }
    } else if(session.step === 2) { // Quote / Guest Ask Alt
        // L5 Guest Step 2 logic: Ask Alt
        if(session.role === 'cust') {
            if(session.altResponseMode === 'open') {
                scriptBubble.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> è«‹å•é‚„æœ‰ä»€éº¼ï¼Ÿ`;
                container.innerHTML = `<h2>ğŸ’¡ é–‹æ”¾å¼è©¢å•</h2><p>å› ç‚ºç¼ºè²¨äº†ï¼Œè«‹è©¢å•è€é—†é‚„æœ‰ä»€éº¼å¯ä»¥è²·ã€‚</p>`;
            } else {
                let altNames = session.oosPairs.map(p => p.alt.name).join("ã€");
                let altCards = session.oosPairs.map(p => `<div class="item-card">${renderItemImg(p.alt)}<span class="item-name">${p.alt.name}</span></div>`).join('');
                scriptBubble.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> é‚£è«‹å•æœ‰ ${altNames} å—ï¼Ÿ`;
                container.innerHTML = `<h2>ğŸ’¡ æ›¿ä»£æ–¹æ¡ˆ</h2><div style="display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">${altCards}</div>`;
            }
            btn.innerText = "èªªå®Œäº†ï¼Œå•åƒ¹æ ¼";
        } 
        // L5 Boss Step 2 logic: Quote
        else {
            scriptBubble.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> ç¸½å…± [ ? ] å…ƒ`;
            let listHtml = session.cart.map(c => `<li>${c.name} $${c.price}</li>`).join('');
            container.innerHTML = `<h2>ğŸ§¾ çµå¸³è¨ˆç®—</h2><ul style="text-align:left; font-size:1.4rem;">${listHtml}</ul><hr><label>ç¸½å…±å¹¾å…ƒï¼Ÿ</label><input type="number" id="boss-input-total" class="big-input" placeholder="?" oninput="updateBubblePrice(this.value)">`;
            btn.innerText = "å ±åƒ¹å®Œç•¢";
        }
    } else if(session.step === 3) { // Pay / Ask Price
         if(session.role === 'cust') {
            scriptBubble.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> è«‹å•å¤šå°‘éŒ¢ï¼Ÿ`; container.innerHTML = `<h1>ğŸ—£ï¸</h1>`; btn.innerText = "èªªå®Œäº†ï¼Œä»˜éŒ¢";
         } else {
            renderCommonCheckout(3, container, scriptBubble, btn);
         }
    } else if(session.step === 4) { // Change / Pay
         if(session.role === 'cust') {
             // Guest Pay (Reuse common)
             renderCommonCheckout(3, container, scriptBubble, btn);
         } else {
             renderCommonCheckout(4, container, scriptBubble, btn);
         }
    } else if(session.step === 5) { // Guest Change
         renderCommonCheckout(4, container, scriptBubble, btn);
    }
}

// Common Checkout
function renderCommonCheckout(phase, container, scriptBubble, btn) {
    if(phase === 3) { // ä»˜æ¬¾
         if(session.role === 'boss') {
            scriptBubble.classList.add('hidden');
            container.innerHTML = `<h2>ğŸ’µ æ”¶éŠ€å°</h2><p style="font-size:1.5rem">æ‡‰æ”¶ï¼š$${session.bossInputPrice}</p><label>æ”¶äº†å¤šå°‘éŒ¢ï¼Ÿ</label><input type="number" id="boss-input-received" class="big-input" placeholder="?">`;
            btn.innerText = "ç¢ºèªé‡‘é¡";
        } else {
            scriptBubble.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> ä»˜éŒ¢çµ¦è€é—†`;
            container.innerHTML = `<h1>ğŸ’°</h1>`;
            btn.innerText = "æ‹¿éŒ¢çµ¦è€é—†";
        }
    } else if(phase === 4) { // æ‰¾éŒ¢/çµæŸ
        if(session.role === 'boss') {
            const received = session.bossInputReceived;
            const price = session.bossInputPrice;
            
            if(received == price) { // å‰›å¥½
                scriptBubble.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> æ”¶æ‚¨ ${received} å…ƒï¼Œè¬è¬å…‰è‡¨ï¼`; 
                container.innerHTML = `<h1>âœ… å‰›å¥½ï¼Œä¸ç”¨æ‰¾éŒ¢</h1>`; 
                btn.innerText = "èªªå®Œäº†ï¼ŒçµæŸäº¤æ˜“"; btn.classList.add('btn-success');
                btn.onclick = () => { session.step = 100; renderStep(); }; 
            } else { // éœ€æ‰¾éŒ¢
                scriptBubble.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> æ‰¾æ‚¨ [ ? ] å…ƒ`; 
                let mathHtml = session.mathHintMode === 'direct' ? `<div style="font-size:2rem; margin:10px;">${received} - ${price} = <span style="color:var(--rose-dark)">?</span></div>` : `<div class="math-hint-container"><div class="math-input-group"><span class="math-label">(æç¤º: å®¢äººä»˜çš„éŒ¢)</span><input type="number" id="calc-paid" class="math-gap"></div><div class="math-symbol">-</div><div class="math-input-group"><span class="math-label">(æç¤º: å•†å“ç¸½é¡)</span><input type="number" id="calc-total" class="math-gap"></div><div class="math-symbol">=</div><span style="color:var(--rose-dark); font-size:1.5rem">?</span></div>`;
                container.innerHTML = `<h2>ğŸ§® è«‹è¨ˆç®—æ‰¾éŒ¢</h2>${mathHtml}<hr><label>æ‡‰æ‰¾å¤šå°‘éŒ¢ï¼Ÿ</label><input type="number" id="boss-input-change" class="big-input" placeholder="?" oninput="updateBubbleChange(this.value)">`;
                btn.innerText = "ç¢ºèªé‡‘é¡";
                btn.onclick = function() { 
                    if(validateCurrentStep()) { 
                        scriptBubble.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> æ”¶æ‚¨ ${received} å…ƒï¼Œæ‰¾æ‚¨ ${session.bossInputChange} å…ƒï¼Œè¬è¬å…‰è‡¨ï¼`; 
                        const inputs = container.querySelectorAll('input'); inputs.forEach(input => input.disabled = true);
                        this.innerText = "èªªå®Œäº†ï¼ŒçµæŸäº¤æ˜“"; this.classList.add('btn-success');
                        this.onclick = () => { session.step = 100; renderStep(); }; 
                    } 
                };
            }
        } else {
            scriptBubble.classList.add('hidden'); container.innerHTML = `<h2>â³ ç­‰å¾…è€é—†æ‰¾éŒ¢/çµå¸³</h2>`; btn.innerText = "æ‹¿åˆ°ç™¼ç¥¨/æ‰¾éŒ¢äº†";
            btn.onclick = () => { session.step = 100; renderStep(); };
        }
    }
}

function updateBubblePrice(val) { const b=document.querySelector('#script-area'); if(b) b.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> ç¸½å…± ${val} å…ƒ`; }
function updateBubbleChange(val) { const b=document.querySelector('#script-area'); if(b) b.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> æ‰¾æ‚¨ ${val} å…ƒ`; }

// POS System (L3, L4, L5)
function renderPOS(container) {
    let itemsHtml = session.store.items.map(i => {
        let inCart = session.cart.filter(c => c.id === i.id).length;
        let remain = i.stock - inCart;
        let disabled = remain <= 0 ? 'disabled-item' : '';
        let clickFn = `addToCart(${i.id})`;
        
        // L5 ç¼ºè²¨æ¨™è¨˜ï¼šä¸æ“‹åœ–ç‰‡
        let oosLabel = '';
        if(session.level === '5' && session.oosPairs.find(p=>p.oos.id===i.id)) {
            oosLabel = '<div class="badge-oos" style="position:absolute;top:5px;right:5px;border:2px solid red;color:red;background:white;font-size:1rem;padding:2px;">ç¼ºè²¨</div>';
        }

        return `<div class="item-card ${disabled}" onclick="${clickFn}">${oosLabel}${renderItemImg(i,'small')}<span class="item-name">${i.name}</span><span class="item-stock">å‰©: ${remain}</span></div>`;
    }).join('');
    let cartHtml = session.cart.length === 0 ? "(ç©º)" : session.cart.map((c, idx) => `<div style="display:flex; justify-content:space-between; align-items:center; margin:5px 0; border-bottom:1px solid #ddd; padding:5px;"><span>${c.name}</span><button class="pos-del-btn" onclick="removeFromCart(${idx})">X</button></div>`).join('');
    container.innerHTML = `<div style="display:flex; gap:10px; width:100%; height:100%;"><div style="flex:2;" class="item-grid">${itemsHtml}</div><div style="flex:1; background:rgba(0,0,0,0.05); padding:10px; border-radius:10px; overflow-y:auto;"><h3>å·²é»æ¸…å–®</h3><div id="pos-list">${cartHtml}</div></div></div>`;
}

function addToCart(itemId) {
    let item = session.store.items.find(i => i.id === itemId);
    
    // Level 5 Logic
    if(session.level === '5' && session.role === 'boss') {
        let oosPair = session.oosPairs.find(p => p.oos.id === itemId);
        if(oosPair) {
             const b=document.querySelector('#script-area');
             if(b) b.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> ${item.name} æ²’æœ‰å–”ï¼Œè³£å®Œäº†`;
             return; // ä¸åŠ å…¥æ¸…å–®
        }
        let altPair = session.oosPairs.find(p => p.alt.id === itemId);
        if(altPair) {
             const b=document.querySelector('#script-area');
             if(b) b.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> æœ‰å–”ï¼Œæˆ‘å€‘æœ‰ ${item.name}`;
        } else {
             const b=document.querySelector('#script-area'); // Normal item
             if(b) b.innerHTML = `<span class="speech-icon">ğŸ—£ï¸</span> å¥½çš„ï¼Œ${item.name}`;
        }
    }

    let inCart = session.cart.filter(c => c.id === itemId).length;
    if(inCart >= item.stock) return;
    session.cart.push({id: item.id, name: item.name, price: item.price});
    renderPOS(document.getElementById('card-area'));
}

function removeFromCart(idx) {
    session.cart.splice(idx, 1);
    renderPOS(document.getElementById('card-area'));
}

function renderProgressBar() {
    const bar = document.getElementById('progress-bar'); bar.classList.remove('hidden');
    let steps = [];
    if(session.level === '5') {
        if(session.role === 'boss') steps = ['é»é¤/ç¼ºè²¨', 'è¨ˆç®—å ±åƒ¹', 'ä»˜æ¬¾/æ”¶éŒ¢', 'æ‰¾éŒ¢/å®Œæˆ'];
        else steps = ['é¸è³¼/é»é¤', 'è©¢å•/æ›¿ä»£', 'è©¢å•åƒ¹æ ¼', 'ä»˜æ¬¾', 'æ‰¾éŒ¢/å®Œæˆ'];
    }
    else if (['3','4'].includes(session.level)) steps = ['é»é¤/POS', 'è¨ˆç®—å ±åƒ¹', 'ä»˜æ¬¾/æ”¶éŒ¢', 'æ‰¾éŒ¢/å®Œæˆ'];
    else steps = ['é¸è³¼/æ¸…å–®', 'è¨ˆç®—å ±åƒ¹', 'ä»˜æ¬¾/æ”¶éŒ¢', 'æ‰¾éŒ¢/å®Œæˆ'];
    
    bar.style.setProperty('--step-count', steps.length);
    bar.innerHTML = `<div class="progress-track-container"><div class="progress-track-bg"></div><div class="progress-track-fill" id="progress-track-fill"></div></div>` + steps.map((s, idx) => `<div class="progress-step" id="prog-step-${idx}"><span>${s}</span></div>`).join('');
    updateProgressBar();
}

function updateProgressBar() {
    const total = document.querySelectorAll('.progress-step').length;
    let idx = session.step - 1;
    if(idx >= total) idx = total - 1;
    document.querySelectorAll('.progress-step').forEach((el, i) => { i<=idx?el.classList.add('active'):el.classList.remove('active'); });
    const fill = document.getElementById('progress-track-fill');
    if(fill && total > 1) fill.style.width = ((idx/(total-1))*100) + "%";
}

function renderEndScreen(container, scriptBubble, btn) {
    scriptBubble.classList.add('hidden'); container.innerHTML = `<h1 style="font-size:4rem; color:var(--rose-dark); margin-top:50px;">äº¤æ˜“æˆåŠŸï¼ğŸ‰</h1><p>åšå¾—å¾ˆå¥½ï¼</p>`;
    btn.innerText = "ğŸ  è¿”å›é¦–é "; btn.classList.remove('btn-success'); btn.onclick = () => location.reload(); document.getElementById('progress-bar').classList.add('hidden');
}

function renderItemImg(item, size='normal') { return item.imgType==='url'&&item.imgData?`<img src="${item.imgData}" class="item-img-real" style="${size==='small'?'width:50px;height:50px;':'width:100px;height:100px;'}">`:`<span class="item-img" style="${size==='small'?'font-size:2rem':''}">${item.icon}</span>`; }
function showAdmin() { hideAll(); document.getElementById('admin-view').classList.remove('hidden'); renderAdminList(); }
function renderAdminList() {
    const div = document.getElementById('admin-list');
    div.innerHTML = stores.map((s, sIdx) => `
        <div class="admin-store-box">
            <div class="store-header"><div style="flex-grow:1;" onclick="toggleStore(${sIdx})"><span id="icon-s-${sIdx}" class="store-toggle-icon">â–¼</span><input type="text" class="store-name-input" value="${s.name}" onclick="event.stopPropagation()" onchange="updateStoreName(${sIdx}, this.value)"></div><div><button class="btn btn-danger" style="padding:8px 15px; font-size:1rem; display:inline-block;" onclick="event.stopPropagation(); requestDeleteStore(this, ${sIdx})">åˆªé™¤å•†åº—</button></div></div>
            <div id="store-items-${sIdx}" class="store-items collapsed">${s.items.map((item, iIdx) => `<div class="admin-item-row"><div style="width:60px; text-align:center;">${renderItemImg(item, 'small')}</div><input type="text" value="${item.name}" style="width:120px;" onchange="updateItem(${sIdx}, ${iIdx}, 'name', this.value)"> åº«å­˜: <input type="number" value="${item.stock}" style="width:60px;" onchange="updateItem(${sIdx}, ${iIdx}, 'stock', this.value)"> <label class="file-upload-btn">æ›´æ›åœ–ç‰‡<input type="file" accept="image/*" style="display:none" onchange="uploadImg(${sIdx}, ${iIdx}, this)"></label> <button class="btn btn-danger" style="padding:5px 10px; font-size:0.9rem; margin-left:auto;" onclick="requestDeleteItem(this, ${sIdx}, ${iIdx})">X</button></div>`).join('')}<div style="text-align:center; margin-top:15px;"><button class="btn btn-success" style="padding:8px 20px; font-size:1rem; width:auto;" onclick="addItem(${sIdx})">+ æ–°å¢å•†å“</button></div></div></div>`).join('');
}
window.toggleStore = function(sIdx) { const el=document.getElementById(`store-items-${sIdx}`), icon=document.getElementById(`icon-s-${sIdx}`); el.classList.toggle('collapsed'); icon.innerText=el.classList.contains('collapsed')?'â–¼':'â–²'; }
window.updateStoreName = function(sIdx, newName) { stores[sIdx].name = newName; saveStores(); };
window.updateItem = function(sIdx, iIdx, field, val) { if(field==='stock') val=parseInt(val); stores[sIdx].items[iIdx][field] = val; saveStores(); };
window.uploadImg = function(sIdx, iIdx, input) { if(input.files[0]) { var r = new FileReader(); r.onload = function(e) { compressImage(e.target.result).then(compressed => { stores[sIdx].items[iIdx].imgType='url'; stores[sIdx].items[iIdx].imgData=compressed; saveStores(); renderAdminList(); setTimeout(()=>toggleStore(sIdx),100); }); }; r.readAsDataURL(input.files[0]); } };
window.addItem = function(sIdx) { stores[sIdx].items.push({id:Date.now(), name:'æ–°å•†å“', icon:'ğŸ“¦', imgType:'icon', stock:5}); saveStores(); renderAdminList(); setTimeout(()=>toggleStore(sIdx),100); };
window.requestDeleteStore = function(btn, sIdx) { if(btn.getAttribute('data-confirm')==='true') { stores.splice(sIdx, 1); saveStores(); renderAdminList(); } else { btn.setAttribute('data-confirm','true'); btn.innerText="ç¢ºå®šåˆªé™¤?"; btn.classList.remove('btn-danger'); btn.classList.add('btn-warning'); setTimeout(()=>{ if(document.body.contains(btn)){btn.setAttribute('data-confirm','false'); btn.innerText="åˆªé™¤å•†åº—"; btn.classList.remove('btn-warning'); btn.classList.add('btn-danger');} }, 3000); } };
window.requestDeleteItem = function(btn, sIdx, iIdx) { if(btn.getAttribute('data-confirm')==='true') { stores[sIdx].items.splice(iIdx, 1); saveStores(); renderAdminList(); setTimeout(()=>toggleStore(sIdx),100); } else { btn.setAttribute('data-confirm','true'); btn.innerText="ç¢ºå®š?"; btn.classList.remove('btn-danger'); btn.classList.add('btn-warning'); setTimeout(()=>{ if(document.body.contains(btn)){btn.setAttribute('data-confirm','false'); btn.innerText="X"; btn.classList.remove('btn-warning'); btn.classList.add('btn-danger');} }, 3000); } };
window.addNewStore = function() { const n=prompt("è«‹è¼¸å…¥æ–°å•†åº—åç¨±"); if(n){ stores.push({id:'s'+Date.now(), name:n, items:[]}); saveStores(); renderAdminList(); } };
window.downloadSampleCSV = function() { const blob=new Blob(["\uFEFFå•†åº—åç¨±,å•†å“åç¨±,åº«å­˜\nç¾å‘³æ¼¢å ¡åº—,æ¼¢å ¡,5"], {type:'text/csv;charset=utf-8;'}); const link=document.createElement("a"); link.href=URL.createObjectURL(blob); link.download="å•†åº—åŒ¯å…¥ç¯„ä¾‹.csv"; link.click(); };
window.processCSV = function(input) { if(!input.files[0])return; const r=new FileReader(); r.onload=function(e){ const rows=e.target.result.split('\n'); let cnt=0; rows.forEach((r,i)=>{ if(i===0)return; const c=r.trim().split(','); if(c.length<3)return; const sn=c[0].trim(), iname=c[1].trim(), st=parseInt(c[2].trim())||0; if(!sn||!iname)return; let s=stores.find(x=>x.name===sn); if(!s){s={id:'s'+Date.now()+Math.random(),name:sn,items:[]}; stores.push(s);} s.items.push({id:Date.now()+Math.random(),name:iname,icon:'ğŸ“¦',imgType:'icon',stock:st}); cnt++; }); saveStores(); renderAdminList(); alert(`æˆåŠŸåŒ¯å…¥ ${cnt} å€‹å•†å“ï¼`); input.value=''; }; r.readAsText(input.files[0]); };
function resetDefaultData() { if(confirm('ç¢ºå®šé‡ç½®ï¼Ÿ')) { localStorage.removeItem('stores'); location.reload(); } }
function hideAll() { ['home-view','setup-view','game-view','admin-view'].forEach(id=>document.getElementById(id).classList.add('hidden')); }

// Init
initApp();
</script>
</body>
</html>